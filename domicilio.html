<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GOSA - Domicilio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="sistema.css">
    <style>
        .domicilio-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px 25px;
            border: 1px solid var(--gray-dark);
            text-align: center;
        }

        .stat-numero {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5em;
            line-height: 1;
        }

        .stat-numero.pendiente { color: var(--warning); }
        .stat-numero.entregado { color: var(--success); }

        .stat-label {
            font-size: 0.9em;
            color: var(--gray-light);
            margin-top: 5px;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--gray-light);
            font-size: 0.9em;
        }

        .auto-refresh input {
            accent-color: var(--gold);
        }

        .tiempo-espera {
            font-size: 0.85em;
            color: var(--gray-light);
            margin-top: 5px;
        }

        .tiempo-espera.urgente {
            color: var(--danger);
            font-weight: bold;
        }

        .domicilio-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(23, 162, 184, 0.2);
            border: 1px solid var(--info);
            color: var(--info);
            padding: 5px 12px;
            border-radius: 20px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9em;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="sistema-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <img src="images/logo.jpeg" alt="GOSA Logo" class="logo">
            <h1><i class="fas fa-motorcycle"></i> DOMICILIO</h1>
        </div>
        <nav class="header-nav">
            <a href="pedidos.html" class="nav-btn">Pedidos</a>
            <a href="cocina.html" class="nav-btn">Cocina</a>
            <a href="domicilio.html" class="nav-btn active">Domicilio</a>
            <a href="cierre.html" class="nav-btn">Cierre</a>
            <a href="index.html" class="nav-btn">Menu</a>
        </nav>
    </header>

    <!-- Contenido -->
    <div class="cocina-container">
        <!-- Estadísticas -->
        <div class="domicilio-stats" id="stats">
            <div class="stat-box">
                <div class="stat-numero pendiente" id="statPendientes">0</div>
                <div class="stat-label">Listos para entregar</div>
            </div>
            <div class="stat-box">
                <div class="stat-numero entregado" id="statEntregados">0</div>
                <div class="stat-label">Entregados Hoy</div>
            </div>
            <div class="auto-refresh">
                <input type="checkbox" id="autoRefresh" checked>
                <label for="autoRefresh">Auto-actualizar cada 5s</label>
            </div>
        </div>

        <!-- Grid de Pedidos Domicilio -->
        <div class="cocina-grid" id="pedidosGrid">
            <div class="loading">Cargando pedidos de domicilio</div>
        </div>
    </div>

    <script src="sistema.js"></script>
    <script>
        // ========== VARIABLES ==========
        let pedidosActuales = [];
        let intervaloRefresh = null;
        let ultimoPedidoId = 0;

        // ========== VERIFICAR SI ES DOMICILIO ==========
        function esDomicilio(notas) {
            if (!notas) return false;
            return notas.includes('[DOMICILIO]');
        }

        // ========== LIMPIAR MARCADOR DE NOTAS ==========
        function formatearNotas(notas) {
            if (!notas) return '';
            return notas.replace('[DOMICILIO]', '').trim();
        }

        // ========== INICIALIZACIÓN ==========
        document.addEventListener('DOMContentLoaded', function() {
            if (!GOSA.apiConfigurada()) {
                GOSA.mostrarConfigPendiente(document.getElementById('pedidosGrid'));
                return;
            }
            cargarPedidos();

            document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);
            toggleAutoRefresh();
        });

        // ========== TOGGLE AUTO-REFRESH ==========
        function toggleAutoRefresh() {
            if (intervaloRefresh) {
                clearInterval(intervaloRefresh);
                intervaloRefresh = null;
            }
            if (document.getElementById('autoRefresh').checked) {
                intervaloRefresh = setInterval(cargarPedidos, 5000);
            }
        }

        // ========== CARGAR PEDIDOS ==========
        async function cargarPedidos() {
            try {
                const resultado = await GOSA.getPedidosHoy();
                if (resultado.error) throw new Error(resultado.error);

                // Obtener fecha de hoy y filtrar solo pedidos de hoy
                const hoy = GOSA.fechaHoy();
                const todosHoy = (resultado.pedidos || []).filter(p => p.fecha === hoy);

                // Domicilios listos para entregar
                const listos = todosHoy.filter(p => p.estado === 'listo' && esDomicilio(p.notas));

                // Domicilios ya entregados (estadística)
                const entregados = todosHoy.filter(p => p.estado === 'entregado' && esDomicilio(p.notas));

                // Notificación de nuevos pedidos listos
                const nuevos = listos.filter(p => p.id > ultimoPedidoId);
                if (nuevos.length > 0 && ultimoPedidoId > 0) {
                    GOSA.reproducirSonido('nuevo');
                    GOSA.vibrar(300);
                }
                if (listos.length > 0) {
                    ultimoPedidoId = Math.max(...listos.map(p => p.id));
                }

                pedidosActuales = listos;

                // Estadísticas
                document.getElementById('statPendientes').textContent = listos.length;
                document.getElementById('statEntregados').textContent = entregados.length;

                renderizarPedidos(listos);

            } catch (error) {
                console.error('Error cargando pedidos:', error);
                document.getElementById('pedidosGrid').innerHTML = `
                    <div class="mensaje error">Error al cargar: ${error.message}</div>
                `;
            }
        }

        // ========== RENDERIZAR PEDIDOS ==========
        function renderizarPedidos(pedidos) {
            const grid = document.getElementById('pedidosGrid');

            if (pedidos.length === 0) {
                grid.innerHTML = `
                    <div class="sin-datos">
                        <i class="fas fa-check-circle"></i>
                        No hay pedidos de domicilio pendientes
                    </div>
                `;
                return;
            }

            // Ordenar por ID (más antiguos primero)
            pedidos.sort((a, b) => a.id - b.id);

            grid.innerHTML = pedidos.map(pedido => {
                const tiempoEspera = calcularTiempoEspera(pedido.hora);
                const esUrgente = tiempoEspera >= 20;

                return `
                    <div class="pedido-card listo">
                        <div class="pedido-header">
                            <div>
                                <div class="pedido-numero">#${pedido.id}</div>
                                <div class="pedido-hora">
                                    <i class="fas fa-clock"></i> ${formatearHora(pedido.hora)}
                                </div>
                                <div class="tiempo-espera ${esUrgente ? 'urgente' : ''}">
                                    ${tiempoEspera} min desde el pedido
                                </div>
                            </div>
                            <span class="pedido-estado listo">LISTO</span>
                        </div>

                        <div class="domicilio-badge">
                            <i class="fas fa-motorcycle"></i> DOMICILIO
                        </div>

                        <div class="pedido-lista">
                            ${pedido.items.map(item => `
                                <div class="pedido-lista-item">
                                    <span>
                                        <span class="item-cantidad">${item.cantidad}x</span>
                                        <span class="item-nombre">${item.nombre}</span>
                                    </span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="pedido-total">
                            <div class="total-linea">
                                <span>TOTAL:</span>
                                <span>${GOSA.formatearPrecio(pedido.total)}</span>
                            </div>
                        </div>

                        ${formatearNotas(pedido.notas) ? `
                            <div class="pedido-notas-cocina">
                                <i class="fas fa-comment"></i> ${formatearNotas(pedido.notas)}
                            </div>
                        ` : ''}

                        <div class="pedido-acciones">
                            <button class="btn-estado btn-entregado" onclick="marcarEntregado(${pedido.id})">
                                <i class="fas fa-hand-holding"></i> ENTREGADO
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== FORMATEAR HORA ==========
        function formatearHora(hora) {
            if (!hora) return '--:--';
            if (hora.match(/^\d{2}:\d{2}:\d{2}$/)) return hora.substring(0, 5);
            if (hora.includes('GMT') || hora.includes('T')) {
                try { return new Date(hora).toTimeString().substring(0, 5); }
                catch(e) { return '--:--'; }
            }
            if (hora.match(/^\d{2}:\d{2}$/)) return hora;
            return String(hora).substring(0, 5);
        }

        // ========== CALCULAR TIEMPO DE ESPERA ==========
        function calcularTiempoEspera(horaPedido) {
            try {
                const ahora = new Date();
                let horaPedidoDate;

                if (horaPedido && horaPedido.match(/^\d{2}:\d{2}(:\d{2})?$/)) {
                    const [horas, minutos, segundos] = horaPedido.split(':').map(Number);
                    horaPedidoDate = new Date();
                    horaPedidoDate.setHours(horas, minutos, segundos || 0);
                } else if (horaPedido && (horaPedido.includes('GMT') || horaPedido.includes('T'))) {
                    horaPedidoDate = new Date(horaPedido);
                    const tempDate = new Date();
                    tempDate.setHours(horaPedidoDate.getHours(), horaPedidoDate.getMinutes(), horaPedidoDate.getSeconds());
                    horaPedidoDate = tempDate;
                } else {
                    return 0;
                }
                return Math.max(0, Math.floor((ahora - horaPedidoDate) / 60000));
            } catch(e) {
                return 0;
            }
        }

        // ========== MARCAR COMO ENTREGADO ==========
        async function marcarEntregado(id) {
            GOSA.vibrar();

            // Efecto de carga en la card
            const cards = document.querySelectorAll('.pedido-card');
            cards.forEach(card => {
                if (card.querySelector('.pedido-numero').textContent === `#${id}`) {
                    card.style.opacity = '0.5';
                    card.style.pointerEvents = 'none';
                }
            });

            try {
                const resultado = await GOSA.actualizarEstadoPedido(id, 'entregado');
                if (resultado.success) {
                    GOSA.reproducirSonido('success');
                    await cargarPedidos();
                } else {
                    throw new Error(resultado.error || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar: ' + error.message);
                await cargarPedidos();
            }
        }
    </script>
</body>
</html>
