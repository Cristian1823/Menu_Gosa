<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GOSA - Cocina</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="sistema.css">
    <style>
        /* Estilos adicionales para cocina */
        .cocina-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px 25px;
            border: 1px solid var(--gray-dark);
            text-align: center;
        }

        .stat-numero {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5em;
            line-height: 1;
        }

        .stat-numero.pendiente { color: var(--danger); }
        .stat-numero.preparando { color: var(--warning); }
        .stat-numero.listo { color: var(--success); }

        .stat-label {
            font-size: 0.9em;
            color: var(--gray-light);
            margin-top: 5px;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--gray-light);
            font-size: 0.9em;
        }

        .auto-refresh input {
            accent-color: var(--gold);
        }

        .tiempo-espera {
            font-size: 0.85em;
            color: var(--gray-light);
            margin-top: 5px;
        }

        .tiempo-espera.urgente {
            color: var(--danger);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="sistema-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <img src="images/logo.jpeg" alt="GOSA Logo" class="logo">
            <h1><i class="fas fa-fire-burner"></i> COCINA</h1>
        </div>
        <nav class="header-nav">
            <a href="pedidos.html" class="nav-btn">Pedidos</a>
            <a href="cocina.html" class="nav-btn active">Cocina</a>
            <a href="domicilio.html" class="nav-btn">Domicilio</a>
            <a href="cierre.html" class="nav-btn">Cierre</a>
            <a href="index.html" class="nav-btn">Menu</a>
        </nav>
    </header>

    <!-- Contenido -->
    <div class="cocina-container">
        <!-- Estadísticas -->
        <div class="cocina-stats" id="stats">
            <div class="stat-box">
                <div class="stat-numero pendiente" id="statPendientes">0</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-box">
                <div class="stat-numero preparando" id="statPreparando">0</div>
                <div class="stat-label">Preparando</div>
            </div>
            <div class="stat-box">
                <div class="stat-numero listo" id="statListos">0</div>
                <div class="stat-label">Listos Hoy</div>
            </div>
            <div class="auto-refresh">
                <input type="checkbox" id="autoRefresh" checked>
                <label for="autoRefresh">Auto-actualizar cada 5s</label>
            </div>
        </div>

        <!-- Grid de Pedidos -->
        <div class="cocina-grid" id="pedidosGrid">
            <div class="loading">Cargando pedidos</div>
        </div>
    </div>

    <!-- Modal Editar Pedido -->
    <div class="modal-overlay" id="modalEditar" style="display: none;" onclick="cerrarModalOverlay(event)">
        <div class="modal-panel">
            <div class="modal-header">
                <span class="modal-titulo" id="modalTitulo">Editar Pedido</span>
                <button class="btn-cerrar-modal" onclick="cerrarModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-section-title">Productos actuales</div>
                <div id="modalItems"></div>
                <div class="modal-section-title" style="margin-top: 15px;">Agregar productos</div>
                <div id="modalProductos"></div>
                <div class="modal-section-title" style="margin-top: 15px;">Opciones del pedido</div>
                <label class="domicilio-check" id="modalDomicilioLabel" onclick="toggleModalDomicilio()">
                    <input type="checkbox" id="modalDomicilio">
                    <i class="fas fa-motorcycle"></i> Es para domicilio
                </label>
                <textarea id="modalNotas" placeholder="Notas del pedido (direccion, sin cebolla, etc.)" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--gray-dark); background: rgba(30,30,30,0.9); color: var(--white); font-family: 'Inter', sans-serif; resize: none; height: 60px;"></textarea>
            </div>
            <div class="modal-footer">
                <div class="modal-total">
                    <span>TOTAL:</span>
                    <span id="modalTotal">$0</span>
                </div>
                <div class="modal-botones">
                    <button class="btn-estado btn-listo" id="btnGuardarEdicion" onclick="guardarEdicion()">
                        <i class="fas fa-floppy-disk"></i> GUARDAR
                    </button>
                    <button class="btn-limpiar" onclick="cerrarModal()" style="margin-top: 0;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="sistema.js"></script>
    <script>
        // ========== VARIABLES ==========
        let pedidosActuales = [];
        let intervaloRefresh = null;
        let ultimoPedidoId = 0;

        // ========== INICIALIZACIÓN ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar configuración
            if (!GOSA.apiConfigurada()) {
                GOSA.mostrarConfigPendiente(document.getElementById('pedidosGrid'));
                return;
            }

            // Cargar pedidos
            cargarPedidos();

            // Configurar auto-refresh
            const checkAutoRefresh = document.getElementById('autoRefresh');
            checkAutoRefresh.addEventListener('change', toggleAutoRefresh);
            toggleAutoRefresh();
        });

        // ========== TOGGLE AUTO-REFRESH ==========
        function toggleAutoRefresh() {
            const activo = document.getElementById('autoRefresh').checked;

            if (intervaloRefresh) {
                clearInterval(intervaloRefresh);
                intervaloRefresh = null;
            }

            if (activo) {
                intervaloRefresh = setInterval(cargarPedidos, 5000);
            }
        }

        // ========== CARGAR PEDIDOS ==========
        async function cargarPedidos() {
            try {
                // Obtener pedidos pendientes y preparando
                const resultado = await GOSA.getPedidosPendientes();

                if (resultado.error) {
                    throw new Error(resultado.error);
                }

                // Obtener todos los pedidos de hoy para estadísticas
                const todosHoy = await GOSA.getPedidosHoy();

                // Verificar si hay nuevos pedidos
                const nuevos = resultado.pedidos.filter(p => p.id > ultimoPedidoId && p.estado === 'pendiente');
                if (nuevos.length > 0 && ultimoPedidoId > 0) {
                    GOSA.reproducirSonido('nuevo');
                    GOSA.vibrar(300);
                }

                // Actualizar último ID
                if (resultado.pedidos.length > 0) {
                    ultimoPedidoId = Math.max(...resultado.pedidos.map(p => p.id));
                }

                pedidosActuales = resultado.pedidos;

                // Actualizar estadísticas
                actualizarEstadisticas(resultado.pedidos, todosHoy.pedidos || []);

                // Renderizar pedidos
                renderizarPedidos(resultado.pedidos);

            } catch (error) {
                console.error('Error cargando pedidos:', error);
                document.getElementById('pedidosGrid').innerHTML = `
                    <div class="mensaje error">
                        Error al cargar pedidos: ${error.message}
                    </div>
                `;
            }
        }

        // ========== ACTUALIZAR ESTADÍSTICAS ==========
        function actualizarEstadisticas(pendientes, todosHoy) {
            // Obtener fecha de hoy en formato YYYY-MM-DD
            const hoy = GOSA.fechaHoy();

            // Filtrar solo pedidos de hoy
            const pedidosHoy = todosHoy.filter(p => p.fecha === hoy);
            const pendientesHoy = pendientes.filter(p => p.fecha === hoy);

            const numPendientes = pendientesHoy.filter(p => p.estado === 'pendiente').length;
            const numPreparando = pendientesHoy.filter(p => p.estado === 'preparando').length;
            const numListos = pedidosHoy.filter(p => p.estado === 'listo' || p.estado === 'entregado').length;

            document.getElementById('statPendientes').textContent = numPendientes;
            document.getElementById('statPreparando').textContent = numPreparando;
            document.getElementById('statListos').textContent = numListos;
        }

        // ========== RENDERIZAR PEDIDOS ==========
        function renderizarPedidos(pedidos) {
            const grid = document.getElementById('pedidosGrid');

            if (pedidos.length === 0) {
                grid.innerHTML = `
                    <div class="sin-datos">
                        <i class="fas fa-check-circle"></i>
                        No hay pedidos pendientes
                    </div>
                `;
                return;
            }

            // Ordenar: pendientes primero, luego por ID (más antiguos primero)
            pedidos.sort((a, b) => {
                if (a.estado === 'pendiente' && b.estado !== 'pendiente') return -1;
                if (a.estado !== 'pendiente' && b.estado === 'pendiente') return 1;
                return a.id - b.id;
            });

            grid.innerHTML = pedidos.map(pedido => {
                const tiempoEspera = calcularTiempoEspera(pedido.hora);
                const esUrgente = tiempoEspera >= 10;

                return `
                    <div class="pedido-card ${pedido.estado}">
                        <div class="pedido-header">
                            <div>
                                <div class="pedido-numero">#${pedido.id}</div>
                                <div class="pedido-hora">
                                    <i class="fas fa-clock"></i> ${formatearHora(pedido.hora)}
                                </div>
                                <div class="tiempo-espera ${esUrgente ? 'urgente' : ''}">
                                    ${tiempoEspera} min esperando
                                </div>
                            </div>
                            <span class="pedido-estado ${pedido.estado}">
                                ${pedido.estado.toUpperCase()}
                            </span>
                        </div>

                        <div class="pedido-lista">
                            ${pedido.items.map(item => `
                                <div class="pedido-lista-item">
                                    <span>
                                        <span class="item-cantidad">${item.cantidad}x</span>
                                        <span class="item-nombre">${item.nombre}</span>
                                    </span>
                                </div>
                            `).join('')}
                        </div>

                        ${pedido.notas ? `
                            <div class="pedido-notas-cocina">
                                <i class="fas fa-comment"></i> ${pedido.notas}
                            </div>
                        ` : ''}

                        <div class="pedido-acciones">
                            ${renderizarBotones(pedido)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== RENDERIZAR BOTONES SEGÚN ESTADO ==========
        function renderizarBotones(pedido) {
            switch (pedido.estado) {
                case 'pendiente':
                    return `
                        <button class="btn-estado btn-preparando" onclick="cambiarEstado(${pedido.id}, 'preparando')">
                            <i class="fas fa-fire"></i> PREPARANDO
                        </button>
                        <button class="btn-editar" onclick="abrirEditar(${pedido.id})">
                            <i class="fas fa-pen"></i>
                        </button>
                    `;
                case 'preparando':
                    return `
                        <button class="btn-estado btn-listo" onclick="cambiarEstado(${pedido.id}, 'listo')">
                            <i class="fas fa-check"></i> LISTO
                        </button>
                        <button class="btn-editar" onclick="abrirEditar(${pedido.id})">
                            <i class="fas fa-pen"></i>
                        </button>
                    `;
                case 'listo':
                    return `
                        <button class="btn-estado btn-entregado" onclick="cambiarEstado(${pedido.id}, 'entregado')">
                            <i class="fas fa-hand-holding"></i> ENTREGADO
                        </button>
                    `;
                default:
                    return '';
            }
        }

        // ========== FORMATEAR HORA ==========
        function formatearHora(hora) {
            if (!hora) return '--:--';

            // Si ya está en formato HH:mm:ss
            if (hora.match(/^\d{2}:\d{2}:\d{2}$/)) {
                return hora.substring(0, 5);
            }

            // Si es un string de fecha completa
            if (hora.includes('GMT') || hora.includes('T')) {
                try {
                    const d = new Date(hora);
                    return d.toTimeString().substring(0, 5);
                } catch(e) {
                    return '--:--';
                }
            }

            // Si tiene formato corto HH:mm
            if (hora.match(/^\d{2}:\d{2}$/)) {
                return hora;
            }

            return String(hora).substring(0, 5);
        }

        // ========== CALCULAR TIEMPO DE ESPERA ==========
        function calcularTiempoEspera(horaPedido) {
            try {
                const ahora = new Date();
                let horaPedidoDate;

                // Si es formato HH:mm:ss
                if (horaPedido && horaPedido.match(/^\d{2}:\d{2}(:\d{2})?$/)) {
                    const [horas, minutos, segundos] = horaPedido.split(':').map(Number);
                    horaPedidoDate = new Date();
                    horaPedidoDate.setHours(horas, minutos, segundos || 0);
                }
                // Si es un string de fecha completa
                else if (horaPedido && (horaPedido.includes('GMT') || horaPedido.includes('T'))) {
                    horaPedidoDate = new Date(horaPedido);
                    // Solo usar la parte de la hora
                    const tempDate = new Date();
                    tempDate.setHours(horaPedidoDate.getHours(), horaPedidoDate.getMinutes(), horaPedidoDate.getSeconds());
                    horaPedidoDate = tempDate;
                } else {
                    return 0;
                }

                const diffMs = ahora - horaPedidoDate;
                const diffMins = Math.floor(diffMs / 60000);

                return Math.max(0, diffMins);
            } catch(e) {
                console.error('Error calculando tiempo:', e);
                return 0;
            }
        }

        // ========== EDITAR PEDIDO ==========
        let pedidoEditando = null;

        function abrirEditar(id) {
            const pedido = pedidosActuales.find(p => p.id === id);
            if (!pedido) return;

            const notas = pedido.notas || '';
            const esDomicilio = notas.includes('[DOMICILIO]');
            const notasLimpias = notas.replace('[DOMICILIO]', '').trim();

            pedidoEditando = {
                id: pedido.id,
                items: pedido.items.map(item => ({...item})),
                esDomicilio: esDomicilio,
                notas: notasLimpias
            };

            document.getElementById('modalTitulo').textContent = `Editar Pedido #${pedido.id}`;
            document.getElementById('modalDomicilio').checked = esDomicilio;
            const label = document.getElementById('modalDomicilioLabel');
            label.classList.toggle('activo', esDomicilio);
            document.getElementById('modalNotas').value = notasLimpias;
            renderizarModalItems();
            renderizarModalProductos();
            actualizarModalTotal();
            document.getElementById('modalEditar').style.display = 'flex';
        }

        function toggleModalDomicilio() {
            setTimeout(() => {
                const checked = document.getElementById('modalDomicilio').checked;
                pedidoEditando.esDomicilio = checked;
                document.getElementById('modalDomicilioLabel').classList.toggle('activo', checked);
            }, 0);
        }

        function cerrarModal() {
            document.getElementById('modalEditar').style.display = 'none';
            pedidoEditando = null;
        }

        function cerrarModalOverlay(event) {
            if (event.target === document.getElementById('modalEditar')) {
                cerrarModal();
            }
        }

        function renderizarModalItems() {
            const container = document.getElementById('modalItems');

            if (pedidoEditando.items.length === 0) {
                container.innerHTML = '<p style="color: var(--danger); text-align: center; padding: 10px; font-size: 0.9em;">Agrega al menos un producto</p>';
                return;
            }

            container.innerHTML = pedidoEditando.items.map(item => `
                <div class="pedido-item">
                    <div class="pedido-item-info">
                        <div class="pedido-item-nombre">${item.nombre}</div>
                        <div class="pedido-item-precio">${GOSA.formatearPrecio(item.precio)} c/u</div>
                    </div>
                    <div class="pedido-item-controles">
                        <button class="cantidad-btn menos" onclick="modificarCantidadModal('${item.nombre}', -1)">-</button>
                        <span class="cantidad-numero">${item.cantidad}</span>
                        <button class="cantidad-btn mas" onclick="modificarCantidadModal('${item.nombre}', 1)">+</button>
                    </div>
                </div>
            `).join('');
        }

        function renderizarModalProductos() {
            const container = document.getElementById('modalProductos');
            let html = '';

            Object.keys(GOSA.MENU).forEach(categoria => {
                const productos = GOSA.MENU[categoria];
                html += `
                    <div class="categoria-titulo" style="font-size: 1.1em; margin-top: 10px; margin-bottom: 8px; padding-bottom: 5px;">
                        <i class="fas ${GOSA.CATEGORIAS_ICONOS[categoria]}"></i> ${GOSA.CATEGORIAS_NOMBRES[categoria]}
                    </div>
                    <div class="productos-grid modal-productos-grid">
                        ${productos.map(producto => `
                            <button class="producto-btn" onclick="agregarProductoModal(event, '${producto.nombre}', ${producto.precio})">
                                <div class="producto-nombre">${producto.nombre}</div>
                                <div class="producto-precio">${GOSA.formatearPrecio(producto.precio)}</div>
                            </button>
                        `).join('')}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function agregarProductoModal(event, nombre, precio) {
            const existente = pedidoEditando.items.find(i => i.nombre === nombre);

            if (existente) {
                existente.cantidad++;
            } else {
                pedidoEditando.items.push({ nombre, precio, cantidad: 1 });
            }

            event.currentTarget.classList.add('added');
            setTimeout(() => event.currentTarget.classList.remove('added'), 300);

            GOSA.vibrar(30);
            renderizarModalItems();
            actualizarModalTotal();
        }

        function modificarCantidadModal(nombre, delta) {
            const item = pedidoEditando.items.find(i => i.nombre === nombre);
            if (!item) return;

            item.cantidad += delta;
            if (item.cantidad <= 0) {
                pedidoEditando.items = pedidoEditando.items.filter(i => i.nombre !== nombre);
            }

            GOSA.vibrar(30);
            renderizarModalItems();
            actualizarModalTotal();
        }

        function actualizarModalTotal() {
            const total = pedidoEditando.items.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            document.getElementById('modalTotal').textContent = GOSA.formatearPrecio(total);
        }

        async function guardarEdicion() {
            if (pedidoEditando.items.length === 0) {
                alert('Agrega al menos un producto antes de guardar');
                return;
            }

            const btn = document.getElementById('btnGuardarEdicion');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GUARDANDO...';

            const total = pedidoEditando.items.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);

            // Construir notas con marcador de domicilio
            const notasTexto = document.getElementById('modalNotas').value.trim();
            const esDomicilio = document.getElementById('modalDomicilio').checked;
            const notas = esDomicilio ? `[DOMICILIO] ${notasTexto}` : notasTexto;

            try {
                const resultado = await GOSA.actualizarPedido(pedidoEditando.id, pedidoEditando.items, total, notas);

                if (resultado.success) {
                    GOSA.reproducirSonido('success');
                    cerrarModal();
                    await cargarPedidos();
                } else {
                    throw new Error(resultado.error || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error editando pedido:', error);
                alert('Error al guardar: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-floppy-disk"></i> GUARDAR';
            }
        }

        // ========== CAMBIAR ESTADO ==========
        async function cambiarEstado(id, nuevoEstado) {
            // Feedback inmediato
            GOSA.vibrar();

            // Encontrar la card y agregar efecto de carga
            const cards = document.querySelectorAll('.pedido-card');
            cards.forEach(card => {
                if (card.querySelector('.pedido-numero').textContent === `#${id}`) {
                    card.style.opacity = '0.5';
                    card.style.pointerEvents = 'none';
                }
            });

            try {
                const resultado = await GOSA.actualizarEstadoPedido(id, nuevoEstado);

                if (resultado.success) {
                    GOSA.reproducirSonido('success');

                    // Recargar pedidos
                    await cargarPedidos();
                } else {
                    throw new Error(resultado.error || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error actualizando estado:', error);
                alert('Error al actualizar: ' + error.message);

                // Recargar para restaurar estado
                await cargarPedidos();
            }
        }
    </script>
</body>
</html>
